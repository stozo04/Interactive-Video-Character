# Bug: Non-Greeting "Missed You" Triggered by Local Reloads

**Status:** Open  
**Severity:** Low (UX/consistency)  
**Component:** Greeting System  
**Related Files:**  
- `src/services/system_prompts/builders/greetingPromptBuilders/index.ts`  
- `src/services/geminiChatService.ts`  

---

## Problem Summary

When the app reloads locally (hot reload/refresh), the non-greeting path generates a "welcome back" response. For deeply loving relationships, the prompt explicitly nudges "Missed you already," so the LLM produces reunion language even if the user was away for ~1 minute.

This feels unnatural during development (rapid reloads) and in real usage for short drop-offs.

---

## Reproduction

1. Run the app locally.
2. Trigger `generateNonGreeting` (e.g., reload after you already chatted today).
3. Observe the non-greeting text response includes "Missed you already" or similar affectionate reunion language after a very short gap.

---

## Root Cause Analysis

- `buildNonGreetingPrompt` has no awareness of **time away** or **reason for return**.  
- The prompt contains fixed examples like "Back so soon?" and for deeply loving it explicitly suggests `"Missed you already."`.
- The system only distinguishes **first login of the day** vs **already chatted today**, which is too coarse for short gaps or reloads.

Result: quick reloads are treated like genuine returns, producing overly emotional "missed you" language.

---

## Proposed Resolution (LLM-Driven, No Hard-Coded Lines)

### 1) Pass Return Context Into the Prompt
Compute a "return context" and pass it to `buildNonGreetingPrompt`:

- `minutes_since_last_user_message` (from `conversation_history` )

### 2) Replace Fixed Example Phrases with Behavioral Rules
Replace the current rule block with LLM-guided constraints that avoid hard-coded text:

- If time away is **very short** or the resume reason is **reload**, avoid reunion/long-absence language.  
- If there are **multiple quick resumes**, allow a playful, lightly self-aware line about the on/off cadence.  
- If the absence is **meaningful** (longer gap), allow warmer “missed you” emotional tone.  
- Always keep tone aligned to relationship tier.

### 3) Keep the Response LLM-Generated
Do not include quoted phrases in the prompt. Use descriptive guidance only; let Gemini generate the actual wording.

---

## Verification Plan

1. **Short gap (1–2 min):** Reload quickly → response should feel like a continuation (no “missed you”).  
2. **Medium gap (~10 min):** Return should be casual, maybe slightly playful, not overly intimate.  
3. **Long gap (hours):** Warm/affectionate reunion language is acceptable.  
4. **Rapid reloads:** After 2–3 reloads in a few minutes, response should acknowledge the on/off cadence in a light, natural way.

---

## Notes

This keeps the behavior fully LLM-driven while giving it context to make natural choices. The only “logic” required is computing return context; the language remains generated by Gemini.
