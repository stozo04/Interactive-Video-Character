# Bug: Interaction ID Not Persisting Across App Restarts/Logouts

**Status:** Resolved
**Date Reported:** 2026-01-05
**Severity:** Medium
**Component:** `src/App.tsx`, `src/services/geminiChatService.ts`

---

## Summary

When a user already has a conversation for the day, closing and reopening the app (or signing out and back in) causes a new `interaction_id` to be generated by Gemini. This breaks the continuity of the conversation as the model starts a fresh interaction instead of resuming the existing one for that day.

Expected behavior: The same `interaction_id` should be used for all interactions within a single day, regardless of app restarts or login/logout events.

---

## Symptoms

- User starts a conversation, gets `interaction_id` #1.
- User closes the app and reopens it.
- User continues the conversation.
- Gemini returns a new `interaction_id` #2.
- The conversation context may feel slightly reset or less cohesive because Gemini is starting a new interaction chain.

---

## Root Cause Analysis

### The Problem

In `src/App.tsx`, the `handleSelectCharacter` function correctly retrieves today's most recent `interaction_id` from the database. However, it fails to pass this restored ID to the AI service calls (`generateGreeting` and `generateNonGreeting`). Instead, it passes the component state `aiSession`, which is `null` when the app first loads or after a login.

Because `generateGreeting`/`generateNonGreeting` receive a `null` session, the AI service (Gemini) starts a brand-new interaction and returns a new `interaction_id`. This new ID is then saved to the database, effectively "changing" the ID for the day.

### Code Location

**File:** `src/App.tsx`

**Problematic code:**
```typescript
// Line 1038 - Local session object created and populated with restored ID
const session: AIChatSession = { model: activeService.model };
const existingInteractionId = await conversationHistoryService.getTodaysInteractionId();
if (existingInteractionId) {
  session.interactionId = existingInteractionId; // Correctly restored here
}

// ... later in the same function ...

// BUG: Passing 'aiSession' (state variable which is null) instead of 'session' (local variable with restored ID)
const { greeting, session: updatedSession } = await activeService.generateGreeting(
  aiSession || { model: activeService.model }, // <--- SHOULD BE 'session'
  { ... }
);

// ... and ...

const { greeting: backMessage, session: updatedSession } = await activeService.generateNonGreeting(
  aiSession || { model: activeService.model } // <--- SHOULD BE 'session'
);
```

---

## Proposed Changes

### 1. Update `App.tsx`

Modify `handleSelectCharacter` to pass the local `session` object (which contains the restored `interactionId`) to `generateGreeting` and `generateNonGreeting`.

```diff
-          const { greeting, session: updatedSession } = await activeService.generateGreeting(
-            aiSession || { model: activeService.model },
+          const { greeting, session: updatedSession } = await activeService.generateGreeting(
+            session,
```

```diff
-          const { greeting: backMessage, session: updatedSession } = await activeService.generateNonGreeting(
-            aiSession || { model: activeService.model }
-          );
+          const { greeting: backMessage, session: updatedSession } = await activeService.generateNonGreeting(
+            session
+          );
```

### 2. Verify `interactionId` restoration logic

Ensure that if no interaction ID is found in the DB (first conversation ever for today), a fresh session is used correctly.

---

## Verification Plan

### Automated Tests
- No automated tests currently cover the end-to-end integration of App.tsx state with Gemini Interaction IDs, but unit tests for `getTodaysInteractionId` in `conversationHistoryService.ts` pass.

### Manual Verification
1. Open the app and start a conversation.
2. Verify in the database (or console logs) the `interaction_id`.
3. Close the app (refresh page).
4. Re-select the character.
5. Verify in console logs that "Restoring today's interaction ID" appears and matches the previous ID.
6. Verify that Gemini resumes the conversation without "who said what" confusion or generating a new ID (in the subsequent message log).
7. Perform the same steps after signing out and back in.
